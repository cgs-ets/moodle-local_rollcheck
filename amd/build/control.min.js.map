{"version":3,"sources":["../src/control.js"],"names":["define","$","Log","Ajax","Templates","RollCheckControl","data","self","templates","rollcheck","prototype","main","checkRoll","call","methodname","args","done","response","debug","result","timetowait","setTimeout","classcode","idnumber","starttime","url","initPopup","fail","reason","error","replace","when","render","then","region","first","on","e","preventDefault","option","doOption","html","append","hasClass","addClass","win","window","open","focus","fadeOut","remove","init","control"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Provides the local_rollcheck/control module\n *\n * @package   local_rollcheck\n * @category  output\n * @copyright 2020 Michael Vangelovski\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module local_rollcheck/control\n */\n define(['jquery', 'core/log', 'core/ajax', 'core/templates'], \n    function ($, Log, Ajax, Templates) {\n    'use strict';\n\n    /**\n     * Initializes the ui controls.\n     */\n    function init(data) {\n        Log.debug('local_rollcheck/control: initializing controls of the local_rollcheck ui');\n\n        var control = new RollCheckControl(data);\n        control.main();\n    };\n\n    // Constructor.\n    function RollCheckControl(data) {\n        var self = this;\n        self.data = data;\n        self.templates = {\n            rollcheck: 'local_rollcheck/rollcheck',\n        };\n    };\n\n    RollCheckControl.prototype.main = function () {\n        var self = this;\n\n        // Check whether the roll has been marked.\n        self.checkRoll();\n \n    };\n\n    RollCheckControl.prototype.checkRoll = function() {\n        var self = this;\n\n        return Ajax.call([{\n            methodname: 'local_rollcheck_check_roll',\n            args: {},\n            done: function (response) {\n                Log.debug(\"local_rollcheck/control: check result: \" + response.result);\n\n                if ( response.result != 'needsmarking') {\n                    return;\n                }\n\n                if (response.timetowait) {\n                    // Set a timeout.\n                    Log.debug('local_rollcheck/control: Waiting ' + response.timetowait + ' minutes before checking roll again.');\n                    setTimeout(function() {\n                        self.checkRoll();\n                    }, (response.timetowait*60000));\n                    return;\n                }\n \n                // Set up data and show alert.\n                Log.debug('local_rollcheck/control: Roll has not been marked. Setting up alert.');\n                self.data['classcode'] = response.classcode;\n                self.data['idnumber'] = response.idnumber;\n                self.data['starttime'] = response.starttime;\n                self.data['timetowait'] = response.timetowait;\n                self.data['url'] = response.url;\n                self.initPopup();\n            },\n            fail: function (reason) {\n                Log.debug(\"local_rollcheck/control: Failed to check roll.\");\n                Log.error(reason);\n            }\n        }]);\n    };\n\n    RollCheckControl.prototype.initPopup = function() {\n        var self = this;\n\n        // Set up message text.\n        self.data['alerttext'] = self.data['alerttext'].replace(\"{{classcode}}\", self.data['classcode']);\n\n        // Render popup.\n        $.when(self.render(self.data)).then(function() {\n            // Setup events.\n            self.region = $('.local_rollcheck').first();\n\n            // Handle option click.\n            self.region.on('click', '.option', function(e) {\n                e.preventDefault();\n                var option = $(this);\n                self.doOption(option);\n            });\n\n        });\n    };\n\n    RollCheckControl.prototype.render = function(data) {\n        var self = this;\n\n        // Load the popup via the template.\n        return Templates.render(self.templates.rollcheck, data)\n            .done(function(html) {\n                $('#region-main-box').append(html);\n            })\n            .fail(function(reason) {\n                Log.debug(\"local_rollcheck/control: Failed to render rollcheck popup.\");\n                Log.error(reason);\n                return;\n            });\n    };\n\n\n    RollCheckControl.prototype.doOption = function(option) {\n        var self = this;\n\n        // Check if already submiting.\n        if (self.region.hasClass('submitting')) {\n            return;\n        }\n        self.region.addClass('submitting');\n\n        Ajax.call([{\n            methodname: 'local_rollcheck_save_response',\n            args: {\n                response: option.data('option'),\n                idnumber: self.data['idnumber'],\n                classcode: self.data['classcode'],\n                starttime: self.data['starttime'],\n            },\n            done: function (response) {\n                if (response.result) {\n                    if (option.data('option') == 'markroll') {\n                        if (self.data['url']) {\n                            var win = window.open(self.data['url'], '_blank');\n                            if (win) {\n                                win.focus();\n                            } else {\n                                Log.error(\"local_rollcheck/control: Browser has blocked popup.\");\n                            }\n                        }\n                    }\n                    self.region.fadeOut(400);\n                }\n            },\n            fail: function (reason) {\n                self.region.remove();\n                Log.debug(\"local_rollcheck/control: Failed to submit option.\");\n                Log.error(reason);\n            }\n        }]);\n        \n    };\n\n    return {\n        init: init\n    };\n });"],"file":"control.min.js"}