define ("local_rollcheck/control",["jquery","core/log","core/ajax","core/templates"],function(a,b,c,d){'use strict';function e(a){var b=this;b.data=a;b.templates={rollcheck:"local_rollcheck/rollcheck"}}e.prototype.main=function(){var a=this;a.checkRoll()};e.prototype.checkRoll=function(){var a=this;return c.call([{methodname:"local_rollcheck_check_roll",args:{},done:function done(c){b.debug("local_rollcheck/control: check result: "+c.result);if("needsmarking"!=c.result){return}if(c.timetowait){b.debug("local_rollcheck/control: Waiting "+c.timetowait+" minutes before checking roll again.");setTimeout(function(){a.checkRoll()},6e4*c.timetowait);return}b.debug("local_rollcheck/control: Roll has not been marked. Setting up alert.");a.data.classcode=c.classcode;a.data.idnumber=c.idnumber;a.data.starttime=c.starttime;a.data.timetowait=c.timetowait;a.data.url=c.url;a.initPopup()},fail:function fail(a){b.debug("local_rollcheck/control: Failed to check roll.");b.error(a)}}])};e.prototype.initPopup=function(){var b=this;b.data.alerttext=b.data.alerttext.replace("{{classcode}}",b.data.classcode);a.when(b.render(b.data)).then(function(){b.region=a(".local_rollcheck").first();b.region.on("click",".option",function(c){c.preventDefault();var d=a(this);b.doOption(d)})})};e.prototype.render=function(c){var e=this;return d.render(e.templates.rollcheck,c).done(function(b){a("#region-main-box").append(b)}).fail(function(a){b.debug("local_rollcheck/control: Failed to render rollcheck popup.");b.error(a)})};e.prototype.doOption=function(a){var d=this;if(d.region.hasClass("submitting")){return}d.region.addClass("submitting");c.call([{methodname:"local_rollcheck_save_response",args:{response:a.data("option"),idnumber:d.data.idnumber,classcode:d.data.classcode,starttime:d.data.starttime},done:function done(c){if(c.result){if("markroll"==a.data("option")){if(d.data.url){var e=window.open(d.data.url,"_blank");if(e){e.focus()}else{b.error("local_rollcheck/control: Browser has blocked popup.")}}}d.region.fadeOut(400)}},fail:function fail(a){d.region.remove();b.debug("local_rollcheck/control: Failed to submit option.");b.error(a)}}])};return{init:function(a){b.debug("local_rollcheck/control: initializing controls of the local_rollcheck ui");var c=new e(a);c.main()}}});
//# sourceMappingURL=control.min.js.map
